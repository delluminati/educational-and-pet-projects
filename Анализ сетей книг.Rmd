---
title: 'HW 1: Анализ работы аэропортов и авиалиний'
author: "Лунев Степан, silunev"
output: html_document
---

## Задача

на основе данных (и выданных вопросов) постараться выяснить:

* какие проблемы есть в авиаперевозках
* какие улучшения можно предложить на основе выводов по данным

#### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(ggplot2)
library(R3PO)
library(stringr)

airline = get_hw1_airline_df()
airport = get_hw1_airport_df()
seat = get_hw1_seat_df()
lounge = get_hw1_lounge_df()

get_hw1_questions()
```

Все преобразования данных будут по ходу выполнения задания.


### Вопросы

#### Вопрос 1

**Вопрос:** Люди из каких стран ниже всего оценивают wi-fi в аэропортах?

**Данные:** Для ответа на вопрос нужна таблица airport.

Оставим в таблице только данные о стране автора отзыва, а также его оценку wi-fi в аэропортах, после чего уберем все неизвестные и неполные данные, после чего сгруппируем данные по стране автора и найдем среднюю оценку wi-fi от граждан всех стран из таблицы.

```{r message = FALSE, warning=FALSE, echo = F}
# Из всего массива я выбрал нужные мне для анализа данные, а именно страну автора отзыва, а также оценку wi-fi в аэропортах
airport2 = select(airport, author_country, wifi_connectivity_rating)
# Убрал все NA значения, чтобы остались только полные данные
airport2 = airport2 %>% na.omit(airport2)
# Сгруппировал данные по стране автора и нашел среднюю оценку wi-fi соединения от граждан конкретных стран
airport2 = airport2 %>% group_by(author_country) %>% summarise(mean_wifi = mean(wifi_connectivity_rating))
# Построил график
ggplot(airport2, aes(x = author_country, y = mean_wifi)) + geom_bar(stat = "identity", fill = "#FF7F50", alpha = 0.8, width = 0.5, col = "red") + theme_light() +
  ggtitle("Оценка wi-fi в аэропортах от граждан конкретной страны") +
  xlab("Страны") +
  ylab("Средняя оценка") +
   theme(text = element_text(size=10),
           axis.text.x = element_text(angle=45, hjust=0.9))+
   geom_text(aes(label=mean_wifi), vjust=1.6, color="white", size=3.3)+
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))+
   theme(plot.title = element_text(hjust = 0.5))
```

**Ответ:** График показывает , что ниже всего wi-fi оценивают люди из Польши и Объединенных Арабских Эмиратов (1 из 5 баллов), после идут люди из Австралии и Великобритании.

**Вывод:** Из полученных данных при ответе на данный вопрос пока что нельзя вывести какие-либо практиеские решения и рекомендации, потому что наличие гражданства какой-то конкретной страны никак не связано с оценкой wi-fi в аэропортах. Люди путешествуют по всему миру, поэтому у них нет привязанности к какому-то конкретному аэропорту, что нам не дает сделать практических выводов. Единственное, что можно отметить - высокую требовательность к wi-fi у граждан Польши и ОАЭ.

Необходимо провести исследование оценок wi-fi каждого аэропорта, а не опираться на гражданство посетителей. После того, как мы проведем исследование, мы узнаем конкретную ситуацию в каждом аэропорту, которая позволит нам выявить все проблемные зоны. Со знанием же всех проблемных зон появится возможность устранить все проблемы с wi-fi в аэропортах.
 

#### Вопрос 2

**Вопрос:** Сколько в нашей базе маршрутов с пересадками?

**Данные:** для ответа на вопрос нужна таблица airline.

Оставим в таблице только данные о содержании отзыва, а также о маршруте человека, который его написал. После производим поиск всех упоминаний "via" после которого следует слово с верхним регистром, что позволяет убрать нам все упоминания "via" в неправильном контексте. Дальше объединяем все упоминания "via" в правильном контексте из данных о содержании отзыва и маршруте и создаем новую переменную, которая показывает конечное количество маршрутов с пересадками.
```{r echo=FALSE, message=FALSE, warning=FALSE}
airline2 = airline %>% select(content, route)
str_content_counted = str_count(airline2$content, "(?<=via).[:upper:]")
str_route_counted = str_count(airline2$route, " via ")
mutant = airline %>% mutate(transfers = case_when(str_content_counted >= "1" ~ "TRUE", str_route_counted >= "1" ~ "TRUE", TRUE ~ "FALSE"))
mutant_summarised = mutant %>% count(transfers)

ggplot(data = mutant, aes(x = transfers)) +
geom_bar(aes(fill = transfers),alpha = 0.8, show.legend = FALSE, width = 0.5)+
scale_y_continuous(breaks = scales::pretty_breaks(n = 20))+theme_bw()+
scale_x_discrete(labels=c("FALSE"="Без пересадки","TRUE"="С пересадкой"))+
  xlab("Маршруты")+
  ylab("Количество")+
  ggtitle("Число маршрутов с пересадками и без пересадок")+
    theme(plot.title = element_text(hjust = 0.5))
```

**Ответ:** На графике можно увидеть, что в данной для анализа базе 103 маршрута с пересадками, когда маршрутов без пересадок - 897. 

**Вывод:** Такая большая разница может исходить из того, что люди предпочитают тратить меньше времени на дорогу, не хотят испытвать лишних неудобств, и поэтому выбирают прямые рейсы, несмотря на зачастую большую стоимость по сравнению с пересадочными рейсами.

Авиакомпании могут увеличить свою прибыль путем увеличения рейсов с пересадкой (Рейсы со стыковкой более выгодные, чем прямые, т.к. увеличивается загрузка пассажирских мест, когда на дальние направления зачастую остаются пустые места). Но для этого надо обеспечить заинтересованность людей к пересадочным рейсам. Сделать это можно путем создания комфортных условий ожидания, небольшого понижения стоимости билетов, а также комфортного трансфера в другой самолет, что позволит минимизировать неудобства и повысит спрос на рейсы с пересадкой.

#### Вопрос 3

**Вопрос:** Какие лаунж-зоны оценены по чистоте (cleanliness) выше, чем аэропорты, в которых они расположены?

**Данные:** для ответа на вопрос нужны таблицы airport и lounge.

Оставим в таблице airport только данные о названии аэропорта, а также рейтинга чистоты в терминале, а в таблице lounge оставим данные про название аэропорта, названия лаунж-зон, а также их рейтинг чистоты. После убираем все неизвестные и неполные данные. Переводим названия аэропортов в обеих таблицах к верхнему регистру и соединяем их по названию аэропорта. После же мы находим средний рейтинг чистоты самого аэропорта, а также средний рейтинг чистоты лаунж-зон в нем, т.к. в отзывах они бывают совершенно разные. После этого мы убираем все дублирующиеся значения, а после вычисляем разницу между рейтингом чистоты аэропорта и лаунжей, которые в нем находятся. Далее мы фильтруем данные, чтобы остались только значения, где лаунж-зона чище, чем ее аэропорт.

**_Чистота в аэропортах и их лаунж-зонах_**

```{r echo = F, message=FALSE, warning=FALSE}
airport3 = select(airport, airport_name, terminal_cleanliness_rating)
lounge3 = select(lounge, airport, lounge_name, cleanliness_rating)
airport3 = airport3 %>% na.omit(airport3)
lounge3 = lounge3 %>% na.omit(lounge3)
airport3$airport_name = str_replace_all(airport3$airport_name, "-", " ")
airport3$airport_name = str_to_upper(airport3$airport_name)
lounge3$airport = str_to_upper(lounge3$airport)
airport3 = rename(airport3, c("airport" = "airport_name"))
airlounge = inner_join(airport3, lounge3, by = "airport")
airlounge$lounge_name = str_replace(airlounge$lounge_name, "CUSTOMER.*$|REVIEW.*$", "")
lounge_mean = airlounge %>% group_by(lounge_name) %>% summarise(mean_cleanliness_rating = mean(cleanliness_rating))
terminal_mean = airlounge %>% group_by(airport) %>% summarise(mean_tr = mean(terminal_cleanliness_rating))
baza = select(airlounge, airport, lounge_name)
baza = baza[!duplicated(baza$lounge_name), ]
baza = inner_join(baza, lounge_mean, by = "lounge_name")
baza = inner_join(baza, terminal_mean, by = "airport")
baza$mean_cleanliness_rating = round(baza$mean_cleanliness_rating, 2)
baza$mean_tr = round(baza$mean_tr, 2)
baza = baza %>% mutate(dif_rating = mean_cleanliness_rating - mean_tr)
baza = baza %>% filter(dif_rating>0)
baza1 = baza %>% top_n(10)
DT::datatable(baza, options = list(bPaginate = TRUE), colnames = c("Аэропорт" = "airport", "Название лаунж-зоны" = "lounge_name", "Средняя оценка чистоты лаунж-зоны" = "mean_cleanliness_rating", "Средняя оценка чистоты аэропорта" = "mean_tr", "Разница" = "dif_rating"))

```

**_Самые большие различия в чистоте аэропортов и лаунж-зон в них_**

```{r echo = F, message=FALSE, warning=FALSE}
ggplot(baza1, aes(x = lounge_name, y = dif_rating, fill = airport)) + geom_bar(stat = "identity", alpha = 0.8, show.legend = FALSE, width = 0.5) + theme_light()+
  ggtitle("Самые большие различия между оценкой\nчистоты лаунж-зоны и аэропорта")+
  xlab("Имя лаунж-зоны")+
  ylab("Разница в оценке")+
  theme(plot.title = element_text(hjust = 1))+
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))+
   geom_text(aes(label=dif_rating), vjust=-1.1, size=3.2, color="blue")+
  coord_flip()
```

**Ответ:** Всего 104 лаунжа оценены по чистоте выше, чем аэропорты, где они расположены. С полным списком этих лаунж-зон можно ознакомиться в таблице выше. 

**Вывод:** Такой ответ дает нам понять, что в аэропортах не так волнуются за чистоту, как в лаунж-зонах. Необходимо улучшать чистоту в аэропортах. Также необходимо провести дополнительные исследования на тему:

1. Какие аэропорты лучше по чистоте, чем лаунж-зоны в них.

2. Узнать, где низкий уровень чистоты и в аэропорту, и в лаунж-зонах, которые в нем.

Эти исследования помогут нам выявить аэропорты, а также лаунж-зоны, которые недостаточно хорошо убирают, после чего можно будет выявить проблемы с уборкой в конкретных аэропортах и начать решать их.

### Дэшборд

Полученные выводы обобщены в виде дэшборда со следующими элементами 

**Элемент 1:** 

 - вид: таблица

 - ответ на вопрос: 3

 - обоснование: таблица может показать наглядно и удобно полный список лаунж-зон, которые чище аэропортов, принимающих их, с чем не может справиться число, а график будет слишком тяжелым для восприятия, мною выделены уровни чистоты в лаунжах и аэропортах, а также их разница, что позволяет максимально понять ситуацию с чистотой в представленных аэропортах и лаунжах.
 
**Элемент 2:** 

 - вид: числа

 - ответ на вопрос: 3

 - обоснование: число передает конкретное значение лучше, чем таблица и график, т.к. те слишком массивны для такого и просто будут засорять дэшборд.
 
**Элемент 3:** 

 - вид: график

 - ответ на вопрос: 3

 - обоснование: данный график способен грамотно дополнить ответ на данный вопрос, показав самую большую разницу наиболее ярко и интересно, у нас несколько чисел и переменных, поэтому число не пойдет (число - одно), и таблица не пойдет, так как график наиболее наглядно показывает информацию о тренде. Это способствует более быстрому восприятию информации, нежели если бы это была таблица. 
 
**Элемент 4:** 

 - вид: числа

 - ответ на вопрос: 2

 - обоснование: число передает конкретное значение лучше, чем таблица и график, т.к. те слишком массивны для такого и просто не нужны, также отмечена большая разница с количеством рейсов без пересадок.
 
### Общие выводы

1. Аэропорты и авиалинии имеют множество проблем, которые стоит решать, чтобы увеличить качество предоставляемых людям услуг.

2. Данная работа показывает лишь малую часть проблем, однако их решение уже бы принесло пользу всем клиентам аэропортов и авиалиний. Первым - более качественные услуги, вторым - больше прибыли. 

3. Маршрутов без пересадок почти в 9 раз больше, чем с пересадками. Компаниям следует начать увеличивать количество рейсов с пересадками, т.к. это позволит заметно поднять им прибыль. Однако не стоит забывать и про множество других факторов.

4. Для комплексного анализа работы аэропортов и авиалиний проведенных мной исследований совершенно недостаточно, чтобы действительно составить план для улучшения качества всех услуг аэропортов и авиалиний, необходимо провести еще множество исследований всевозможных факторов, влияющих на что-либо в данной среде.